#! /bin/bash

if qmake --version >/dev/null 2>&1 ; then
    BINQMAKE=qmake
elif qmake-qt5 --version >/dev/null 2>&1 ; then
    BINQMAKE=qmake-qt5
elif qmake5 --version >/dev/null 2>&1 ; then
    BINQMAKE=qmake5
elif qmake-qt4 --version >/dev/null 2>&1 ; then
    BINQMAKE=qmake-qt4
elif qmake4 --version >/dev/null 2>&1 ; then
    BINQMAKE=qmake4
elif $HOME/Qt/5.3/clang_64/bin/qmake --version >/dev/null 2>&1 ; then
    BINQMAKE=$HOME/Qt/5.3/clang_64/bin/qmake
elif $HOME/Qt/5.4/clang_64/bin/qmake --version >/dev/null 2>&1 ; then
    BINQMAKE=$HOME/Qt/5.3/clang_64/bin/qmake
else
    echo qmake not found
    exit
fi

if [ ! $(which cmake) ] ; then
    echo cmake not found
    exit
fi

INSTALL_DIR=$(cd $(dirname "$0") && cd ../../.. && pwd)
cd "$INSTALL_DIR"

if [ ! -d "Blackmagic DeckLink SDK" ] ; then
    wget http://software.blackmagicdesign.com/SDK/Blackmagic_DeckLink_SDK_10.1.4.zip
    unzip Blackmagic_DeckLink_SDK_10.1.4.zip
    mv "Blackmagic DeckLink SDK 10.1.4" "Blackmagic DeckLink SDK"
fi

if [ ! -d ffmpeg ] ; then
    git clone git://source.ffmpeg.org/ffmpeg.git ffmpeg
fi

if [ ! -f ffmpeg/ffmpeg ] ; then
    cd ffmpeg
    FFMPEG_CONFIGURE_OPTS=(--enable-gpl --enable-version3 --disable-securetransport --disable-videotoolbox --disable-shared --enable-static --disable-swscale-alpha --disable-doc --disable-ffplay --disable-ffprobe --disable-ffserver --disable-debug)
    if sw_vers >/dev/null 2>&1 ; then
        FFMPEG_CONFIGURE_OPTS+=(--extra-cflags="-mmacosx-version-min=10.5" --extra-ldflags="-mmacosx-version-min=10.5")
    fi
    chmod u+x configure
    chmod u+x version.sh
    if yasm --version >/dev/null 2>&1 ; then
        ./configure "${FFMPEG_CONFIGURE_OPTS[@]}"
        if [$? -ne 0 ] ; then #on some distro, yasm version is too old
            cd ../yasm/
            ./configure --prefix=`pwd`/usr
            make
            make install

            cd ../ffmpeg
            FFMPEG_CONFIGURE_OPTS+=(--yasmexe=../yasm/usr/bin/yasm)
            ./configure "${FFMPEG_CONFIGURE_OPTS[@]}"
        fi
    else
        cd ../yasm/
        ./configure --prefix=`pwd`/usr
        make
        make install

        cd ../ffmpeg
        FFMPEG_CONFIGURE_OPTS+=(--yasmexe=../yasm/usr/bin/yasm)
        ./configure "${FFMPEG_CONFIGURE_OPTS[@]}"
    fi
    make
    cd ..
fi

if [ ! -d qwt ] ; then
    svn checkout svn://svn.code.sf.net/p/qwt/code/branches/qwt-5.2 qwt
fi
cd qwt
$BINQMAKE
make
cd ..

cd qctools/Project/QtCreator
if sw_vers >/dev/null 2>&1 ; then
    #Qt 5.2 can not well detect the platform version for 10.9 then FFmpeg static link fails
    MAJOR_MAC_VERSION=$(sw_vers -productVersion | awk -F '.' '{print $1 "." $2}')
    $BINQMAKE QMAKE_MAC_SDK=macosx$MAJOR_MAC_VERSION
else
    $BINQMAKE
fi
make
cd ../../..

echo QCTools binary is in qctools/Project/QtCreator
